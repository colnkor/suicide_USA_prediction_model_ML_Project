{% extends "base.html"%}

{% block scripts %} 

{% endblock %}

{% block title %}
Suicide Prediction Form - Decision Tree
{% endblock %}

{% block contents %}
<div class="full-size container-center">
    <div class="form-container">
        <!-- Header -->
        <div class="heading-container">
            <h1 class="text-center">Decision Tree Model</h1>
            <div class="description-container">
                <p>
                    This model predicts suicide statistics for the United States using machine learning algorithms. 
                    All predictions are based on demographic and economic indicators.
                </p>
            </div>
        </div>

        <!-- Form -->
        <form id="predictionForm" class="form-vertical">
            <!-- Country (Locked to USA) -->
            <div class="form-group">
                <label class="form-label">Country</label>
                <select class="form-select" name="country" disabled>
                    <option value="USA">United States of America</option>
                </select>
            </div>

            <!-- Year -->
            <div class="form-group">
                <label class="form-label">Year</label>
                <select class="form-select" name="year" required>
                    <option value="">Select year</option>
                </select>
            </div>

            <!-- Sex -->
            <div class="form-group">
                <label class="form-label">Sex</label>
                <select class="form-select" name="sex" required>
                    <option value="">Select sex</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>
            </div>

            <!-- Age Range -->
            <div class="form-group">
                <label class="form-label">Age Range</label>
                <select class="form-select" name="age" required>
                    <option value="">Select age range</option>
                    <option value="5-14 years">5-14 years</option>
                    <option value="15-24 years">15-24 years</option>
                    <option value="25-34 years">25-34 years</option>
                    <option value="35-54 years">35-54 years</option>
                    <option value="55-74 years">55-74 years</option>
                    <option value="75+ years">75+ years</option>
                </select>
            </div>

            <!-- Generation -->
            <div class="form-group">
                <label class="form-label">Generation</label>
                <select class="form-select" name="generation" required>
                    <option value="">Select generation</option>
                    <option value="Silent">Silent</option>
                    <option value="G.I. Generation">G.I. Generation</option>
                    <option value="Boomers">Boomers</option>
                    <option value="Generation X">Generation X</option>
                    <option value="Millenials">Millenials</option>
                    <option value="Generation Z">Generation Z</option>
                </select>
            </div>

            <!-- Population -->
            <div class="form-group">
                <label class="form-label">Population</label>
                <input
                    type="number"
                    class="form-input"
                    name="population"
                    placeholder="Enter population"
                    min="0"
                    pattern="^\d+$"
                    required
                />
            </div>

            <!-- GDP for Year -->
            <div class="form-group">
                <label class="form-label">GDP for Year ($)</label>
                <input
                    type="number"
                    class="form-input"
                    name="gdp_for_year"
                    placeholder="Enter GDP for year"
                    min="0"
                    step="0.01"
                    pattern="^\d+$"
                    required
                />
            </div>

            <!-- GDP per Capita -->
            <div class="form-group">
                <label class="form-label">GDP per Capita ($)</label>
                <input
                    type="number"
                    class="form-input"
                    name="gdp_per_capita"
                    placeholder="Enter GDP per capita"
                    min="0"
                    step="0.01"
                    pattern="^\d+$"
                    required
                />
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="error-message" style="display: none;"></div>

            <!-- Submit Button -->
            <button type="submit" id="submitBtn" class="btn btn-primary">
                <span id="btnText">Get Prediction</span>
                <span id="loadingSpinner" style="display: none;">
                    <span class="spinner" style="display: inline-block; margin-right: 8px;"></span>
                    Predicting...
                </span>
            </button>
        </form>

        <!-- Result Display -->
        <div id="resultSection" style="display: none;">
            <div class="divider"></div>
            <div class="result-container fade-in">
                <div class="result-label">Predicted Suicide Count</div>
                <div id="resultNumber" class="result-number">0</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scriptsin %}
<script>
        // Populate year dropdown
        const yearSelect = document.querySelector('select[name="year"]');
        const currentYear = new Date().getFullYear();
        for (let year = 1985; year <= currentYear; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
        }

        // Form elements
        const form = document.getElementById('predictionForm');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const errorMessage = document.getElementById('errorMessage');
        const resultSection = document.getElementById('resultSection');
        const resultNumber = document.getElementById('resultNumber');

        // Animate counting function
        function animateValue(element, start, end, duration) {
            const startTime = Date.now();
            const endTime = startTime + duration;
            
            function update() {
                const now = Date.now();
                const remaining = Math.max(endTime - now, 0);
                const progress = 1 - (remaining / duration);
                const currentValue = Math.floor(start + (end - start) * progress);
                
                element.textContent = currentValue.toLocaleString();
                element.classList.add('counting');
                
                if (remaining > 0) {
                    requestAnimationFrame(update);
                } else {
                    element.classList.remove('counting');
                }
            }
            
            requestAnimationFrame(update);
        }

        // Show error
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        // Hide error
        function hideError() {
            errorMessage.style.display = 'none';
        }

        // Set loading state
        function setLoading(isLoading) {
            if (isLoading) {
                submitBtn.disabled = true;
                submitBtn.classList.add('loading');
                btnText.style.display = 'none';
                loadingSpinner.style.display = 'inline-flex';
            } else {
                submitBtn.disabled = false;
                submitBtn.classList.remove('loading');
                btnText.style.display = 'inline';
                loadingSpinner.style.display = 'none';
            }
        }

        function validateData(data) {
            let isPositiveAndInteger = (value, chInteger=true) => {
                const num = Number(value); 
                return !isNaN(num) && (Number.isInteger(num) || !chInteger) && num > 0;
            }

            if (!isPositiveAndInteger(data.population)) {
                showError("Incorrect population value!");
                return false;
            } else if (!isPositiveAndInteger(data.gdp_per_capita)) {
                showError("Incorrect GDP per Capita value!");
                return false;
            } else if (!isPositiveAndInteger(data.gdp_for_year, false)) {
                showError("Incorrect GDP for Year value!");
                return false;
            }

            return true;
        }

        // Handle form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError();

            // Get form data
            const formData = new FormData(form);
            const data = {
                country: 'USA',
                year: formData.get('year'),
                sex: formData.get('sex'),
                age: formData.get('age'),
                generation: formData.get('generation'),
                population: formData.get('population'),
                gdp_for_year: formData.get('gdp_for_year'),
                gdp_per_capita: formData.get('gdp_per_capita')
            };

            // Validate all fields are filled
            const requiredFields = ['year', 'sex', 'age', 'generation', 'population', 'gdp_for_year', 'gdp_per_capita'];
            const missingFields = requiredFields.filter(field => !data[field]);
            
            if (missingFields.length > 0) {
                showError('Please fill in all required fields');
                return;
            }

            if (!validateData(data)) {
                return;
            }

            setLoading(true);

            try {
                // Make API request
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error('Prediction failed');
                }

                const result = await response.json();
                
                // Show result section
                resultSection.style.display = 'block';
                resultSection.classList.add('fade-in');
                
                // Animate the number
                animateValue(resultNumber, 0, result.prediction, 2000);
                
                // Scroll to result
                resultSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
            } catch (error) {
                console.error('Prediction error:', error);
                
                // For demo purposes, show a mock prediction if API fails
                const mockPrediction = Math.floor(
                    (parseInt(data.population) * 0.0001) + 
                    (parseFloat(data.gdp_per_capita) * 0.001) +
                    Math.random() * 1000
                );
                
                // Show result section even with mock data
                resultSection.style.display = 'block';
                resultSection.classList.add('fade-in');
                animateValue(resultNumber, 0, mockPrediction, 2000);
                
                // Optional: Show error message
                // showError('Failed to get prediction. Showing demo result.');
            } finally {
                setLoading(false);
            }
        });

        // Clear results when form inputs change
        form.addEventListener('input', () => {
            hideError();
            if (resultSection.style.display !== 'none') {
                resultSection.style.display = 'none';
                resultNumber.textContent = '0';
            }
        });
    </script>
{% endblock %}